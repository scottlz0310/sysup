# 品質向上計画 - sysup v0.4.0に向けて

## 現状評価（v0.3.0）

### ✅ 達成済み項目
- ✅ 基本的なruff lint/format設定完了
- ✅ mypy型チェック設定完了（strict相当）
- ✅ pytest + pytest-covによるテスト環境整備
- ✅ pre-commit設定完了
- ✅ banditによるセキュリティチェック導入
- ✅ CI/CDパイプライン基本構築（lint/type/test/security）
- ✅ マトリクステスト（Ubuntu/macOS × Python 3.11/3.12/3.13）

### 🔶 改善が必要な項目
- 🔶 テストカバレッジ未達（現状: 目標設定なし → 目標: 80%）
- 🔶 統合テスト・E2Eテストが未整備
- 🔶 セキュリティスキャンが限定的（CodeQL、Secret scanning未導入）
- 🔶 依存関係のSBOM生成未実施
- 🔶 ドキュメントの型アノテーションが不完全
- 🔶 構造化ログが未導入

### � スコープ外項目（将来実装）
- ⏸️ Windows対応（Scoop、Chocolatey、winget等のWindows用パッケージマネージャ対応が必要）
- ⏸️ 現時点の対応環境: Linux、macOS、WSL

---

## Phase 4: リンティング・コード品質

### タスク一覧

#### 4.1 リンター・フォーマッター改善
- [ ] **T4.1-1**: ruffルールセットの拡張
  - 優先度: 高
  - 内容: 以下のルールを追加導入
    - `N` (pep8-naming): 命名規則チェック
    - `D` (pydocstyle): Docstringスタイルチェック（部分的）
    - `RUF` (Ruff-specific rules): Ruff固有の推奨ルール
  - 期待効果: コード品質の統一性向上

- [ ] **T4.1-2**: 行長制限の見直し
  - 優先度: 中
  - 内容: 現在120文字 → コメント/Docstringは72文字に制限
  - 影響範囲: pyproject.toml設定、既存コードの修正

#### 4.2 Docstring整備
- [ ] **T4.2-1**: 全公開API（関数/クラス）にDocstringを追加
  - 優先度: 高
  - 内容:
    - スタイル: Googleスタイルで統一
    - 対象: `src/sysup/`配下の全公開関数・クラス
    - 必須項目: Args, Returns, Raises, Examples（可能な限り）
  - 確認方法: `ruff check --select D` でチェック

- [ ] **T4.2-2**: モジュールレベルDocstringの追加
  - 優先度: 中
  - 内容: 各.pyファイルの先頭にモジュール説明を追加
  - 形式: 1行目に簡潔な説明、その後に詳細説明

#### 4.3 型ヒントの強化
- [ ] **T4.3-1**: mypy strictモードへの段階的移行
  - 優先度: 高
  - 内容:
    - 現状の設定を維持しつつ、以下を追加検討
      ```toml
      disallow_any_generics = true  # ジェネリック型でのAny禁止
      disallow_subclassing_any = true  # Any継承禁止
      disallow_untyped_calls = true  # 型なし関数呼び出し禁止
      ```
  - 段階: v0.4.0で一部導入、v0.5.0で完全strict化

- [ ] **T4.3-2**: 型アノテーション網羅性チェック
  - 優先度: 中
  - 内容: 全ての関数の引数・戻り値に型ヒントがあることを確認
  - ツール: mypy `--disallow-untyped-defs` で検証（既に有効化済み）

#### 4.4 ログ・デバッグ改善
- [ ] **T4.4-1**: printステートメント撲滅
  - 優先度: 高
  - 内容: ruff T20ルールで検出・修正（既に設定済み）
  - 確認: `ruff check --select T20` で残存チェック

- [ ] **T4.4-2**: 構造化ログへの移行検討
  - 優先度: 低（v0.5.0以降）
  - 内容: 現在のRichベースログ → structlog等のJSON形式
  - メリット: 集計・分析が容易、観測性向上

---

## Phase 5: テスト戦略・カバレッジ

### タスク一覧

#### 5.1 単体テストの拡充
- [ ] **T5.1-1**: カバレッジ目標の設定と達成
  - 優先度: **最高**
  - 内容:
    - 現状カバレッジ測定: `pytest --cov=src --cov-report=term-missing`
    - 目標: **80%以上**（行カバレッジ）
    - pyproject.tomlに `fail_under = 80` を設定
  - アクション:
    1. 現状カバレッジレポート確認
    2. 未カバー箇所の特定（coverage.xml / htmlcov/を確認）
    3. 優先度の高いモジュールから順次テスト追加
    4. CI/CDでカバレッジゲート化

- [ ] **T5.1-2**: Updater系クラスの単体テスト強化
  - 優先度: 高
  - 内容:
    - 各Updater（apt/snap/brew/uv等）のテスト追加
    - Mockを活用した外部コマンド実行のテスト
    - エラーケースのテスト（コマンド失敗、タイムアウト等）

- [ ] **T5.1-3**: Core機能の単体テスト追加
  - 優先度: 高
  - 対象モジュール:
    - `config.py`: 設定読み込み・バリデーション
    - `checks.py`: システムチェック機能
    - `stats.py`: 統計情報管理
  - テストケース: 正常系・異常系・境界値

#### 5.2 統合テストの追加
- [ ] **T5.2-1**: 統合テストフレームワーク整備
  - 優先度: 中
  - 内容:
    - `tests/integration/` ディレクトリ作成
    - 実際のファイルI/O、プロセス実行を含むテスト
    - マーカー: `@pytest.mark.integration` で識別
  - 実行方法: `pytest -m integration`

- [ ] **T5.2-2**: CLI全体の統合テスト
  - 優先度: 中
  - 内容:
    - `sysup --dry-run` の動作確認
    - 設定ファイル読み込みテスト
    - バックアップ・ログ生成の検証

#### 5.3 E2Eテストの検討
- [ ] **T5.3-1**: E2Eテストの設計（v0.5.0以降）
  - 優先度: 低
  - 内容:
    - 実環境でのエンドツーエンドテスト
    - Docker環境での自動化検討
    - CIでの実行可能性調査

#### 5.4 テストの質向上
- [ ] **T5.4-1**: 既存テストのレビューと改善
  - 優先度: 高
  - 内容:
    - 既存test_*.pyの品質チェック
    - 無意味なテスト（assert Trueのみ等）の除去
    - テスト名・コメントの明確化
  - 禁止事項の確認:
    - カバレッジ稼ぎのみのテスト
    - @pytest.mark.skipの乱用
    - 重複ファイル（test_*_expanded.py等）

- [ ] **T5.4-2**: Mockの適切な使用
  - 優先度: 中
  - 内容:
    - 外部依存（subprocess、ファイルI/O）のMock化
    - Mock使用ガイドラインの明確化
    - 過度なMock依存の回避

- [ ] **T5.4-3**: テストデータの再現性確保
  - 優先度: 中
  - 内容:
    - 時刻依存処理のfixture化
    - 擬似乱数のseed固定（該当箇所があれば）
    - タイムゾーンUTC統一

---

## Phase 6: CI/CD・自動化

### タスク一覧

#### 6.1 CI/CDの強化
- [ ] **T6.1-1**: キャッシュ戦略の最適化
  - 優先度: 中
  - 内容:
    - uvキャッシュの有効化（`astral-sh/setup-uv`のキャッシュ機能）
    - キャッシュキー: `pyproject.toml` + `uv.lock`
  - 期待効果: CI実行時間の短縮

- [ ] **T6.1-3**: カバレッジゲートの導入
  - 優先度: 高
  - 内容:
    - pytest-covで `--cov-fail-under=80` を設定
    - CIでカバレッジ未達時にビルド失敗
  - タイミング: T5.1-1（カバレッジ80%達成）後に有効化

#### 6.2 セキュリティスキャンの拡充
- [ ] **T6.2-1**: CodeQL導入
  - 優先度: 高
  - 内容:
    - GitHub Advanced SecurityのCodeQLを有効化
    - `.github/workflows/codeql.yml` の作成
    - Python言語の脆弱性スキャン自動化

- [ ] **T6.2-2**: Secret Scanningの有効化
  - 優先度: 高
  - 内容:
    - リポジトリ設定でSecret scanningを有効化
    - Push時の自動スキャン設定
  - 備考: GitHub Advanced Security必要（Publicリポジトリは無料）

- [ ] **T6.2-3**: Dependabot設定
  - 優先度: 高
  - 内容:
    - `.github/dependabot.yml` の作成
    - pip/GitHub Actions依存関係の自動更新
    - セキュリティアラートの自動PR作成

- [ ] **T6.2-4**: SBOM生成の自動化
  - 優先度: 中
  - 内容:
    - CycloneDX等でSBOM（Software Bill of Materials）生成
    - リリース時にSBOMをアーティファクトとして添付
  - ツール候補: `cyclonedx-python`, `syft`

#### 6.3 リリース自動化
- [ ] **T6.3-1**: バージョン管理の自動化
  - 優先度: 中
  - 内容:
    - `bump2version` or `commitizen` の導入
    - タグ作成時の自動バージョンアップ
  - 検証項目: pyproject.toml / CHANGELOG / タグの整合性

- [ ] **T6.3-2**: GitHub Releaseの自動化
  - 優先度: 中
  - 内容:
    - タグpush時にGitHub Releaseを自動作成
    - リリースノート自動生成（Conventional Commits基準）
  - ツール: `release-drafter` or GitHub Actionsのrelease機能

#### 6.4 Pre-commit強化
- [ ] **T6.4-1**: pre-commit設定の見直し
  - 優先度: 低
  - 内容:
    - 現状の設定確認（ruff, mypy等）
    - 追加候補: `check-merge-conflict`, `check-case-conflict`
  - 確認: `.pre-commit-config.yaml` の最新化

---

## Phase 7: セキュリティ・品質保証

### タスク一覧

#### 7.1 セキュリティポリシー整備
- [ ] **T7.1-1**: SECURITY.mdの作成
  - 優先度: 高
  - 内容:
    - 脆弱性報告方法の明記
    - サポートされるバージョン一覧
    - セキュリティアップデート方針

- [ ] **T7.1-2**: 依存関係のライセンス監査
  - 優先度: 中
  - 内容:
    - 使用ライセンスの一覧化
    - 許容/禁止ライセンスの定義
  - ツール: `pip-licenses` or `licensecheck`

#### 7.2 権限最小化
- [ ] **T7.2-1**: GitHub Actions permissionsの見直し
  - 優先度: 中
  - 内容:
    - 現状: `contents: read` のみ
    - 各ジョブごとに必要最小限の権限を設定
    - 例: codecov uploadには `pull-requests: write` が必要

#### 7.3 コンテナ化（将来的検討）
- [ ] **T7.3-1**: Dockerイメージの作成検討
  - 優先度: 低（v0.5.0以降）
  - 内容:
    - Alpine/Distrolessベースの軽量イメージ
    - Trivyでのコンテナスキャン
    - ルートレス実行

---

## Phase 8: 観測性・監視

### タスク一覧

#### 8.1 ログ改善
- [ ] **T8.1-1**: 構造化ログの段階的導入
  - 優先度: 低（v0.5.0以降）
  - 内容:
    - 現在のRichベースログを維持しつつJSON出力オプション追加
    - ログレベルの適切な使用確認（DEBUG/INFO/WARNING/ERROR）

- [ ] **T8.1-2**: トレーシングID導入の検討
  - 優先度: 低
  - 内容:
    - 実行ごとのtrace_id生成
    - ログに自動付与、デバッグ容易化

#### 8.2 メトリクス・監視
- [ ] **T8.2-1**: 実行統計の拡充
  - 優先度: 低
  - 内容:
    - 更新時間、パッケージ数などの統計を詳細化
    - エクスポート形式の検討（JSON/Prometheus形式等）

---

## Phase 9: ドキュメント整備

### タスク一覧

#### 9.1 コードドキュメント
- [ ] **T9.1-1**: APIドキュメント生成
  - 優先度: 中
  - 内容:
    - Sphinxまたはmkdocsでドキュメント生成
    - Docstringから自動生成
    - GitHub Pagesでホスティング

#### 9.2 ユーザードキュメント
- [ ] **T9.2-1**: トラブルシューティングガイド
  - 優先度: 中
  - 内容:
    - よくある問題と解決方法
    - エラーメッセージ一覧と対処法

- [ ] **T9.2-2**: コントリビューションガイド
  - 優先度: 中
  - 内容: CONTRIBUTING.mdの充実化
    - 開発環境セットアップ手順
    - テスト実行方法
    - PR提出ガイドライン

---

## 優先順位マトリクス

### 最優先（v0.4.0で必須）
1. **T5.1-1**: カバレッジ80%達成 🔴
2. **T4.2-1**: Docstring整備 🔴
3. **T6.2-1**: CodeQL導入 🔴
4. **T6.2-2**: Secret Scanning有効化 🔴
5. **T6.2-3**: Dependabot設定 🔴
6. **T7.1-1**: SECURITY.md作成 🔴

### 高優先度（v0.4.0で推奨）
7. **T5.1-2**: Updater単体テスト強化 🟠
8. **T5.1-3**: Core機能単体テスト 🟠
9. **T4.3-1**: mypy strict化 🟠
10. **T6.1-3**: カバレッジゲート導入 🟠
11. **T5.4-1**: 既存テストレビュー 🟠

### 中優先度（v0.4.0〜v0.5.0）
12. **T5.2-1**: 統合テスト整備 🟡
13. **T6.3-1**: バージョン管理自動化 🟡
14. **T9.1-1**: APIドキュメント生成 🟡
15. **T7.1-2**: 依存関係ライセンス監査 🟡

### 低優先度（v0.5.0以降）
16. **T8.1-1**: 構造化ログ導入 🟢
17. **T5.3-1**: E2Eテスト設計 🟢
18. **T7.3-1**: Docker化検討 🟢

---

## マイルストーン

### v0.4.0（品質向上リリース）
**目標日**: 2025年11月上旬
**Exit Criteria**:
- ✅ テストカバレッジ80%達成
- ✅ 全公開APIにDocstring整備
- ✅ CodeQL/Secret Scanning/Dependabot有効化
- ✅ SECURITY.md作成
- ✅ CIでカバレッジゲート有効化

### v0.5.0（Production Ready）
**目標日**: 2025年12月
**Exit Criteria**:
- ✅ mypy strict完全対応
- ✅ 統合テスト整備完了
- ✅ Windowsサポート確認
- ✅ APIドキュメント公開
- ✅ 構造化ログ導入
- ✅ SBOMリリース添付

---

## 実施手順

### Week 1: 現状分析とテスト拡充
- [ ] 現在のカバレッジ測定・分析
- [ ] 未カバー箇所の優先順位付け
- [ ] Updater系テスト追加開始

### Week 2: セキュリティ強化
- [ ] CodeQL設定
- [ ] Secret Scanning有効化
- [ ] Dependabot設定
- [ ] SECURITY.md作成

### Week 3: Docstring整備と型強化
- [ ] 全モジュールDocstring追加
- [ ] mypy strict設定調整
- [ ] 既存テストレビュー

### Week 4: CI/CD強化と統合
- [ ] カバレッジゲート有効化
- [ ] Windowsマトリクス追加
- [ ] リリース自動化検討
- [ ] v0.4.0リリース準備

---

## 成功指標（KPI）

### 品質指標
- テストカバレッジ: **80%以上** 📊
- mypyエラー: **0件** ✅
- ruffエラー: **0件** ✅
- bandit重大度High以上: **0件** 🔒
- Docstring完備率: **100%**（公開API） 📝

### セキュリティ指標
- CodeQL検出脆弱性: **0件** 🔐
- Dependabot未対応アラート: **0件** 🔔
- SBOM生成: **あり** 📦

### CI/CD指標
- CI実行時間: **10分以内** ⏱️
- CI成功率: **95%以上** ✅
- リリース頻度: **月1回以上** 🚀

---

## レビュー・承認プロセス

### 品質ゲート
各フェーズの完了には以下の承認が必要：
1. **コードレビュー**: 最低1名の承認
2. **CI/CD**: 全チェックがパス
3. **カバレッジ**: 閾値達成
4. **セキュリティ**: 未解決脆弱性0件

### 例外承認
品質ルールの逸脱には以下が必要：
- 逸脱理由の文書化
- 代替策の提示
- 再評価期限の設定
- 承認者の明記

---

## 参考資料
- [品質ルールドキュメント](.amazonq/rules/quality-rules.md)
- [実装計画](docs/implement/sysup-implementation-plan.md)
- [CONTRIBUTING.md](docs/CONTRIBUTING.md)

---

**最終更新**: 2025-10-08
**次回レビュー**: v0.4.0リリース後
